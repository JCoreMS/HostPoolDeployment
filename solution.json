{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.11.1.770",
      "templateHash": "3338727373570583316"
    }
  },
  "parameters": {
    "_artifactsLocation": {
      "type": "string"
    },
    "_artifactsLocationSasToken": {
      "type": "secureString"
    },
    "AppGroupName": {
      "type": "string"
    },
    "AppGroupType": {
      "type": "string",
      "allowedValues": [
        "Desktop",
        "RailApplications"
      ]
    },
    "Availability": {
      "type": "string",
      "defaultValue": "None",
      "metadata": {
        "description": "Set the desired availability / SLA with a pooled host pool.  Choose \"None\" if deploying a personal host pool."
      },
      "allowedValues": [
        "AvailabilitySet",
        "AvailabilityZones",
        "None"
      ]
    },
    "ComputeGalleryName": {
      "type": "string"
    },
    "ComputeGallerySubId": {
      "type": "string"
    },
    "ComputeGalleryRG": {
      "type": "string"
    },
    "ComputeGalleryImage": {
      "type": "string"
    },
    "TrustedLaunch": {
      "type": "string"
    },
    "CrossTenantRegister": {
      "type": "bool",
      "metadata": {
        "description": "If TRUE, Resource Group for Host Pool resources not required."
      }
    },
    "CrossTenantRegisterToken": {
      "type": "secureString"
    },
    "CustomRdpProperty": {
      "type": "string"
    },
    "DiskSku": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "metadata": {
        "description": "The storage SKU for the AVD session host disks.  Production deployments should use Premium_LRS."
      },
      "allowedValues": [
        "Standard_LRS",
        "StandardSSD_LRS",
        "Premium_LRS"
      ]
    },
    "DomainName": {
      "type": "string"
    },
    "DomainUser": {
      "type": "string"
    },
    "DomainPassword": {
      "type": "secureString"
    },
    "ResourceGroupHP": {
      "type": "string"
    },
    "HostPoolName": {
      "type": "string"
    },
    "ResourceGroupVMs": {
      "type": "string",
      "defaultValue": ""
    },
    "HostPoolType": {
      "type": "string",
      "metadata": {
        "description": "These options specify the host pool type and depending on the type provides the load balancing options and assignment types."
      },
      "allowedValues": [
        "Pooled DepthFirst",
        "Pooled BreadthFirst",
        "Personal Automatic",
        "Personal Direct"
      ]
    },
    "WorkspaceName": {
      "type": "string"
    },
    "Location": {
      "type": "string"
    },
    "NumSessionHosts": {
      "type": "int"
    },
    "NumUsersPerHost": {
      "type": "int"
    },
    "Subnet": {
      "type": "string"
    },
    "Tags": {
      "type": "object"
    },
    "Timestamp": {
      "type": "string",
      "defaultValue": "[utcNow('u')]"
    },
    "StartVmOnConnect": {
      "type": "bool"
    },
    "OUPath": {
      "type": "string"
    },
    "VmIndexStart": {
      "type": "int",
      "maxValue": 99
    },
    "VmPrefix": {
      "type": "string",
      "maxLength": 13
    },
    "ValidationEnvironment": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "The value determines whether the hostpool should receive early AVD updates for testing."
      }
    },
    "VirtualNetwork": {
      "type": "string",
      "metadata": {
        "description": "Virtual network for the AVD sessions hosts"
      }
    },
    "VirtualNetworkResourceGroup": {
      "type": "string",
      "metadata": {
        "description": "Virtual network resource group for the AVD sessions hosts"
      }
    },
    "VmPassword": {
      "type": "secureString",
      "metadata": {
        "description": "Local administrator password for the AVD session hosts"
      }
    },
    "VmSize": {
      "type": "string",
      "defaultValue": "Standard_D4s_v4",
      "metadata": {
        "description": "The VM SKU for the AVD session hosts."
      }
    },
    "VmUsername": {
      "type": "string",
      "metadata": {
        "description": "The Local Administrator Username for the Session Hosts"
      }
    }
  },
  "variables": {
    "MaxResourcesPerTemplateDeployment": 79,
    "DivisionValue": "[div(parameters('NumSessionHosts'), variables('MaxResourcesPerTemplateDeployment'))]",
    "DivisionRemainderValue": "[mod(parameters('NumSessionHosts'), variables('MaxResourcesPerTemplateDeployment'))]",
    "SessionHostBatchCount": "[if(greater(variables('DivisionRemainderValue'), 0), add(variables('DivisionValue'), 1), variables('DivisionValue'))]",
    "MaxAvSetCount": 200,
    "DivisionAvSetValue": "[div(parameters('NumSessionHosts'), variables('MaxAvSetCount'))]",
    "DivisionAvSetRemainderValue": "[mod(parameters('NumSessionHosts'), variables('MaxAvSetCount'))]",
    "AvailabilitySetCount": "[if(greater(variables('DivisionAvSetRemainderValue'), 0), add(variables('DivisionAvSetValue'), 1), variables('DivisionAvSetValue'))]",
    "PooledHostPool": "[if(equals(split(parameters('HostPoolType'), ' ')[0], 'Pooled'), true(), false())]",
    "AvailabilitySetPrefix": "as-"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[parameters('ResourceGroupHP')]",
      "location": "[parameters('Location')]"
    },
    {
      "condition": "[not(empty(parameters('ResourceGroupVMs')))]",
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[parameters('ResourceGroupVMs')]",
      "location": "[parameters('Location')]"
    },
    {
      "condition": "[and(and(variables('PooledHostPool'), equals(parameters('Availability'), 'AvailabilitySet')), not(parameters('CrossTenantRegister')))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('AvailabilitySets_{0}', parameters('Timestamp'))]",
      "resourceGroup": "[parameters('ResourceGroupHP')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AvailabilitySetCount": {
            "value": "[variables('AvailabilitySetCount')]"
          },
          "AvailabilitySetPrefix": {
            "value": "[variables('AvailabilitySetPrefix')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "7340760399826031854"
            }
          },
          "parameters": {
            "AvailabilitySetCount": {
              "type": "int"
            },
            "AvailabilitySetPrefix": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "Tags": {
              "type": "object"
            }
          },
          "resources": [
            {
              "copy": {
                "name": "availabilitySet",
                "count": "[length(range(0, parameters('AvailabilitySetCount')))]"
              },
              "type": "Microsoft.Compute/availabilitySets",
              "apiVersion": "2019-07-01",
              "name": "[format('{0}-{1}', parameters('AvailabilitySetPrefix'), range(0, parameters('AvailabilitySetCount'))[copyIndex()])]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "sku": {
                "name": "Aligned"
              },
              "properties": {
                "platformUpdateDomainCount": 5,
                "platformFaultDomainCount": 2
              }
            }
          ]
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('ResourceGroupHP'))]"
      ]
    },
    {
      "condition": "[not(parameters('CrossTenantRegister'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "HostPool_linkedDeployment",
      "resourceGroup": "[parameters('ResourceGroupHP')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "AppGroupName": {
            "value": "[parameters('AppGroupName')]"
          },
          "AppGroupType": {
            "value": "[parameters('AppGroupType')]"
          },
          "ComputeGalleryImageId": {
            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('ComputeGallerySubId'), parameters('ComputeGalleryRG')), 'Microsoft.Compute/galleries/images', split(format('{0}/{1}', parameters('ComputeGalleryName'), parameters('ComputeGalleryImage')), '/')[0], split(format('{0}/{1}', parameters('ComputeGalleryName'), parameters('ComputeGalleryImage')), '/')[1])]"
          },
          "CustomRdpProperty": {
            "value": "[parameters('CustomRdpProperty')]"
          },
          "DiskSku": {
            "value": "[parameters('DiskSku')]"
          },
          "DomainName": {
            "value": "[parameters('DomainName')]"
          },
          "HostPoolName": {
            "value": "[parameters('HostPoolName')]"
          },
          "HostPoolType": {
            "value": "[parameters('HostPoolType')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "NumUsersPerHost": {
            "value": "[parameters('NumUsersPerHost')]"
          },
          "StartVmOnConnect": {
            "value": "[parameters('StartVmOnConnect')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "ValidationEnvironment": {
            "value": "[parameters('ValidationEnvironment')]"
          },
          "VmPrefix": {
            "value": "[parameters('VmPrefix')]"
          },
          "VmSize": {
            "value": "[parameters('VmSize')]"
          },
          "WorkspaceName": {
            "value": "[parameters('WorkspaceName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "8005123379711237360"
            }
          },
          "parameters": {
            "AppGroupName": {
              "type": "string"
            },
            "AppGroupType": {
              "type": "string"
            },
            "CustomRdpProperty": {
              "type": "string"
            },
            "DiskSku": {
              "type": "string"
            },
            "DomainName": {
              "type": "string"
            },
            "HostPoolName": {
              "type": "string"
            },
            "HostPoolType": {
              "type": "string"
            },
            "WorkspaceName": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "NumUsersPerHost": {
              "type": "int"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string",
              "defaultValue": "[utcNow('u')]"
            },
            "StartVmOnConnect": {
              "type": "bool"
            },
            "ComputeGalleryImageId": {
              "type": "string"
            },
            "VmPrefix": {
              "type": "string"
            },
            "ValidationEnvironment": {
              "type": "bool"
            },
            "VmSize": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DesktopVirtualization/hostPools",
              "apiVersion": "2021-03-09-preview",
              "name": "[parameters('HostPoolName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "hostPoolType": "[split(parameters('HostPoolType'), ' ')[0]]",
                "maxSessionLimit": "[parameters('NumUsersPerHost')]",
                "loadBalancerType": "[if(contains(parameters('HostPoolType'), 'Pooled'), split(parameters('HostPoolType'), ' ')[1], null())]",
                "validationEnvironment": "[parameters('ValidationEnvironment')]",
                "registrationInfo": {
                  "expirationTime": "[dateTimeAdd(parameters('Timestamp'), 'PT2H')]",
                  "registrationTokenOperation": "Update"
                },
                "preferredAppGroupType": "[parameters('AppGroupType')]",
                "customRdpProperty": "[parameters('CustomRdpProperty')]",
                "personalDesktopAssignmentType": "[if(contains(parameters('HostPoolType'), 'Personal'), split(parameters('HostPoolType'), ' ')[1], null())]",
                "startVMOnConnect": "[parameters('StartVmOnConnect')]",
                "vmTemplate": "[format('{{\"domain\":\"{0}\",\"galleryImageOffer\":null,\"galleryImagePublisher\":null,\"galleryImageSKU\":null,\"imageType\":\"CustomImage\",\"imageUri\":null,\"customImageId\":\"{1}\",\"namePrefix\":\"{2}\",\"osDiskType\":\"{3}\",\"useManagedDisks\":true,\"vmSize\":{{\"id\":\"{4}\",\"cores\":null,\"ram\":null}},\"galleryItemId\":null}}', parameters('DomainName'), parameters('ComputeGalleryImageId'), parameters('VmPrefix'), parameters('DiskSku'), parameters('VmSize'))]"
              }
            },
            {
              "type": "Microsoft.DesktopVirtualization/applicationGroups",
              "apiVersion": "2021-03-09-preview",
              "name": "[parameters('AppGroupName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "hostPoolArmPath": "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('HostPoolName'))]",
                "applicationGroupType": "Desktop"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('HostPoolName'))]"
              ]
            },
            {
              "type": "Microsoft.DesktopVirtualization/workspaces",
              "apiVersion": "2021-03-09-preview",
              "name": "[parameters('WorkspaceName')]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "applicationGroupReferences": [
                  "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('AppGroupName'))]"
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.DesktopVirtualization/applicationGroups', parameters('AppGroupName'))]",
                "[resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('HostPoolName'))]"
              ]
            }
          ],
          "outputs": {
            "HostPoolRegistrationToken": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DesktopVirtualization/hostPools', parameters('HostPoolName'))).registrationInfo.token]"
            },
            "ComputeImageGalleryID": {
              "type": "string",
              "value": "[parameters('ComputeGalleryImageId')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('ResourceGroupHP'))]"
      ]
    },
    {
      "copy": {
        "name": "virtualMachines",
        "count": "[length(range(1, variables('SessionHostBatchCount')))]",
        "mode": "serial",
        "batchSize": 1
      },
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('VirtualMachines_{0}_{1}', sub(range(1, variables('SessionHostBatchCount'))[copyIndex()], 1), guid(parameters('Timestamp')))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          },
          "Availability": {
            "value": "[parameters('Availability')]"
          },
          "AvailabilitySetPrefix": {
            "value": "[variables('AvailabilitySetPrefix')]"
          },
          "ComputeGalleryImageId": {
            "value": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', parameters('ComputeGallerySubId'), parameters('ComputeGalleryRG')), 'Microsoft.Compute/galleries/images', split(format('{0}/{1}', parameters('ComputeGalleryName'), parameters('ComputeGalleryImage')), '/')[0], split(format('{0}/{1}', parameters('ComputeGalleryName'), parameters('ComputeGalleryImage')), '/')[1])]"
          },
          "CrossTenantRegister": {
            "value": "[parameters('CrossTenantRegister')]"
          },
          "CrossTenantRegisterToken": {
            "value": "[parameters('CrossTenantRegisterToken')]"
          },
          "DomainUser": {
            "value": "[parameters('DomainUser')]"
          },
          "DomainPassword": {
            "value": "[parameters('DomainPassword')]"
          },
          "DomainName": {
            "value": "[parameters('DomainName')]"
          },
          "HostPoolRegistrationToken": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroupHP')), 'Microsoft.Resources/deployments', 'HostPool_linkedDeployment'), '2020-10-01').outputs.HostPoolRegistrationToken.value]"
          },
          "OUPath": {
            "value": "[parameters('OUPath')]"
          },
          "Location": {
            "value": "[parameters('Location')]"
          },
          "NumSessionHosts": {
            "value": "[parameters('NumSessionHosts')]"
          },
          "Subnet": {
            "value": "[parameters('Subnet')]"
          },
          "Tags": {
            "value": "[parameters('Tags')]"
          },
          "Timestamp": {
            "value": "[parameters('Timestamp')]"
          },
          "TrustedLaunch": {
            "value": "[parameters('TrustedLaunch')]"
          },
          "VirtualNetwork": {
            "value": "[parameters('VirtualNetwork')]"
          },
          "VirtualNetworkResourceGroup": {
            "value": "[parameters('VirtualNetworkResourceGroup')]"
          },
          "VmIndexStart": {
            "value": "[parameters('VmIndexStart')]"
          },
          "VmSize": {
            "value": "[parameters('VmSize')]"
          },
          "VmUsername": {
            "value": "[parameters('VmUsername')]"
          },
          "VmPassword": {
            "value": "[parameters('VmPassword')]"
          },
          "VmPrefix": {
            "value": "[parameters('VmPrefix')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.11.1.770",
              "templateHash": "14533433464030707948"
            }
          },
          "parameters": {
            "_artifactsLocation": {
              "type": "string"
            },
            "_artifactsLocationSasToken": {
              "type": "secureString"
            },
            "Availability": {
              "type": "string"
            },
            "AvailabilitySetPrefix": {
              "type": "string"
            },
            "ComputeGalleryImageId": {
              "type": "string"
            },
            "CrossTenantRegister": {
              "type": "bool"
            },
            "CrossTenantRegisterToken": {
              "type": "secureString"
            },
            "DomainName": {
              "type": "string"
            },
            "DomainUser": {
              "type": "string"
            },
            "DomainPassword": {
              "type": "secureString"
            },
            "HostPoolRegistrationToken": {
              "type": "string"
            },
            "Location": {
              "type": "string"
            },
            "NumSessionHosts": {
              "type": "int"
            },
            "Subnet": {
              "type": "string"
            },
            "Tags": {
              "type": "object"
            },
            "Timestamp": {
              "type": "string"
            },
            "TrustedLaunch": {
              "type": "string"
            },
            "OUPath": {
              "type": "string"
            },
            "VirtualNetwork": {
              "type": "string"
            },
            "VirtualNetworkResourceGroup": {
              "type": "string"
            },
            "VmIndexStart": {
              "type": "int"
            },
            "VmPrefix": {
              "type": "string"
            },
            "VmSize": {
              "type": "string"
            },
            "VmUsername": {
              "type": "string"
            },
            "VmPassword": {
              "type": "secureString"
            }
          },
          "resources": [
            {
              "copy": {
                "name": "networkInterface",
                "count": "[length(range(0, parameters('NumSessionHosts')))]"
              },
              "type": "Microsoft.Network/networkInterfaces",
              "apiVersion": "2020-05-01",
              "name": "[format('nic-{0}-{1}', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0'))]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "name": "ipconfig",
                    "properties": {
                      "privateIPAllocationMethod": "Dynamic",
                      "subnet": {
                        "id": "[resourceId(subscription().subscriptionId, parameters('VirtualNetworkResourceGroup'), 'Microsoft.Network/virtualNetworks/subnets', parameters('VirtualNetwork'), parameters('Subnet'))]"
                      },
                      "primary": true,
                      "privateIPAddressVersion": "IPv4"
                    }
                  }
                ],
                "enableAcceleratedNetworking": true,
                "enableIPForwarding": false
              }
            },
            {
              "copy": {
                "name": "virtualMachine",
                "count": "[length(range(0, parameters('NumSessionHosts')))]"
              },
              "type": "Microsoft.Compute/virtualMachines",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}{1}', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0'))]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "zones": "[if(equals(parameters('Availability'), 'AvailabilityZones'), createArray(string(add(mod(range(0, parameters('NumSessionHosts'))[copyIndex()], 3), 1))), null())]",
              "properties": {
                "availabilitySet": "[if(equals(parameters('Availability'), 'AvailabilitySet'), createObject('id', resourceId('Microsoft.Compute/availabilitySets', format('{0}-{1}', parameters('AvailabilitySetPrefix'), div(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 200)))), null())]",
                "hardwareProfile": {
                  "vmSize": "[parameters('VmSize')]"
                },
                "storageProfile": {
                  "imageReference": {
                    "id": "[parameters('ComputeGalleryImageId')]"
                  },
                  "osDisk": {
                    "name": "[format('osDisk-{0}{1}', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0'))]",
                    "osType": "Windows",
                    "createOption": "FromImage",
                    "caching": "ReadOnly",
                    "deleteOption": "Delete"
                  },
                  "dataDisks": []
                },
                "osProfile": {
                  "computerName": "[format('{0}{1}', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0'))]",
                  "adminUsername": "[parameters('VmUsername')]",
                  "adminPassword": "[parameters('VmPassword')]",
                  "windowsConfiguration": {
                    "provisionVMAgent": true,
                    "enableAutomaticUpdates": false
                  },
                  "secrets": [],
                  "allowExtensionOperations": true
                },
                "networkProfile": {
                  "networkInterfaces": [
                    {
                      "id": "[resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}-{1}', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0')))]",
                      "properties": {
                        "deleteOption": "Delete"
                      }
                    }
                  ]
                },
                "securityProfile": {
                  "uefiSettings": "[if(equals(parameters('TrustedLaunch'), 'TrustedLaunch'), createObject('secureBootEnabled', true(), 'vTpmEnabled', true()), null())]",
                  "securityType": "[if(equals(parameters('TrustedLaunch'), 'TrustedLaunch'), 'TrustedLaunch', null())]"
                },
                "diagnosticsProfile": {
                  "bootDiagnostics": {
                    "enabled": false
                  }
                },
                "licenseType": "Windows_Client"
              },
              "dependsOn": [
                "networkInterface"
              ]
            },
            {
              "copy": {
                "name": "extension_CustomScriptExtension",
                "count": "[length(range(0, parameters('NumSessionHosts')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}{1}/CustomScriptExtension', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0'))]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "publisher": "Microsoft.Compute",
                "type": "CustomScriptExtension",
                "typeHandlerVersion": "1.10",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "fileUris": [
                    "[format('{0}Register-HostPool.ps1{1}', parameters('_artifactsLocation'), parameters('_artifactsLocationSasToken'))]"
                  ],
                  "timestamp": "[parameters('Timestamp')]"
                },
                "protectedSettings": {
                  "commandToExecute": "[format('powershell -ExecutionPolicy Unrestricted -File Register-HostPool.ps1 -HostPoolRegistration {0} -XTenantRegister {1} -XTenantRegToken {2}', parameters('HostPoolRegistrationToken'), parameters('CrossTenantRegister'), parameters('CrossTenantRegisterToken'))]"
                }
              },
              "dependsOn": [
                "virtualMachine"
              ]
            },
            {
              "copy": {
                "name": "extension_JsonADDomainExtension",
                "count": "[length(range(0, parameters('NumSessionHosts')))]"
              },
              "type": "Microsoft.Compute/virtualMachines/extensions",
              "apiVersion": "2021-03-01",
              "name": "[format('{0}{1}/JsonADDomainExtension', parameters('VmPrefix'), padLeft(add(range(0, parameters('NumSessionHosts'))[copyIndex()], parameters('VmIndexStart')), 3, '0'))]",
              "location": "[parameters('Location')]",
              "tags": "[parameters('Tags')]",
              "properties": {
                "forceUpdateTag": "[parameters('Timestamp')]",
                "publisher": "Microsoft.Compute",
                "type": "JsonADDomainExtension",
                "typeHandlerVersion": "1.3",
                "autoUpgradeMinorVersion": true,
                "settings": {
                  "Name": "[parameters('DomainName')]",
                  "User": "[parameters('DomainUser')]",
                  "Restart": "true",
                  "Options": "3",
                  "OUPath": "[parameters('OUPath')]"
                },
                "protectedSettings": {
                  "Password": "[parameters('DomainPassword')]"
                }
              },
              "dependsOn": [
                "extension_CustomScriptExtension",
                "virtualMachine"
              ]
            }
          ],
          "outputs": {
            "RegistrationToken": {
              "type": "string",
              "value": "[parameters('HostPoolRegistrationToken')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('ResourceGroupHP')), 'Microsoft.Resources/deployments', 'HostPool_linkedDeployment')]"
      ]
    }
  ]
}
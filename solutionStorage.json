{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.29.47.4906",
      "templateHash": "8518499589339140017"
    }
  },
  "parameters": {
    "_artifactsLocation": {
      "type": "string",
      "defaultValue": ""
    },
    "_artifactsLocationSasToken": {
      "type": "string",
      "defaultValue": ""
    },
    "domainGUID": {
      "type": "string",
      "defaultValue": "00000000-0000-0000-0000-000000000000"
    },
    "domainJoinUserName": {
      "type": "string",
      "defaultValue": ""
    },
    "domainJoinUserPassword": {
      "type": "securestring",
      "defaultValue": ""
    },
    "domainFQDN": {
      "type": "string",
      "defaultValue": ""
    },
    "groupAdminsName": {
      "type": "string"
    },
    "groupAdminsGuid": {
      "type": "string"
    },
    "groupUsersName": {
      "type": "string"
    },
    "groupUsersGuid": {
      "type": "string"
    },
    "identityOption": {
      "type": "string",
      "allowedValues": [
        "AD",
        "AADKERB",
        "AADDS",
        "None"
      ]
    },
    "keyExpiration": {
      "type": "int",
      "defaultValue": "[dateTimeToEpoch(dateTimeAdd(utcNow(), 'P1Y'))]",
      "metadata": {
        "description": "Expiration time of the key"
      }
    },
    "keyVaultName": {
      "type": "string"
    },
    "location": {
      "type": "string"
    },
    "managedIdentityName": {
      "type": "string"
    },
    "ouPathStorage": {
      "type": "string",
      "defaultValue": ""
    },
    "ouPathVm": {
      "type": "string",
      "defaultValue": ""
    },
    "privateDNSZoneId": {
      "type": "string"
    },
    "privateDNSZoneKvId": {
      "type": "string"
    },
    "privateEndPointPrefix": {
      "type": "string"
    },
    "storageAcctName": {
      "type": "string"
    },
    "storageFileShareName": {
      "type": "string"
    },
    "storageResourceGroup": {
      "type": "string"
    },
    "storageRedundancy": {
      "type": "string",
      "allowedValues": [
        "ZRS",
        "LRS"
      ]
    },
    "storageShareSize": {
      "type": "int"
    },
    "storageTier": {
      "type": "string",
      "allowedValues": [
        "Standard",
        "Premium"
      ]
    },
    "vmsubnetId": {
      "type": "string",
      "defaultValue": ""
    },
    "storsubnetId": {
      "type": "string"
    },
    "subscriptionId": {
      "type": "string",
      "defaultValue": "[subscription().subscriptionId]"
    },
    "tags": {
      "type": "object"
    },
    "timestamp": {
      "type": "string",
      "defaultValue": "[utcNow()]"
    },
    "vmName": {
      "type": "string",
      "defaultValue": ""
    },
    "vmAdminUsername": {
      "type": "string",
      "defaultValue": ""
    },
    "vmAdminPassword": {
      "type": "securestring",
      "defaultValue": ""
    }
  },
  "variables": {
    "storageSKU": "[format('{0}_{1}', parameters('storageTier'), parameters('storageRedundancy'))]",
    "scriptLocation": "https://raw.githubusercontent.com/JCoreMS/HostPoolDeployment/master/scripts",
    "storageKind": "[if(or(equals(variables('storageSKU'), 'Premium_LRS'), equals(variables('storageSKU'), 'Premium_ZRS')), 'FileStorage', 'StorageV2')]",
    "storageSetupScript": "domainJoinStorageAcct.ps1",
    "tenantId": "[subscription().tenantId]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('linked_ResourceGroup_Resources-{0}', parameters('storageAcctName'))]",
      "resourceGroup": "[parameters('storageResourceGroup')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "domainFQDN": {
            "value": "[parameters('domainFQDN')]"
          },
          "domainGUID": {
            "value": "[parameters('domainGUID')]"
          },
          "domainJoinUserName": {
            "value": "[parameters('domainJoinUserName')]"
          },
          "domainJoinUserPassword": {
            "value": "[parameters('domainJoinUserPassword')]"
          },
          "identityOption": {
            "value": "[parameters('identityOption')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "keyExpiration": {
            "value": "[parameters('keyExpiration')]"
          },
          "keyVaultName": {
            "value": "[parameters('keyVaultName')]"
          },
          "managedIdentityName": {
            "value": "[parameters('managedIdentityName')]"
          },
          "storageAcctName": {
            "value": "[parameters('storageAcctName')]"
          },
          "storageSKU": {
            "value": "[variables('storageSKU')]"
          },
          "vmsubnetId": {
            "value": "[parameters('vmsubnetId')]"
          },
          "tenantId": {
            "value": "[variables('tenantId')]"
          },
          "timestamp": {
            "value": "[parameters('timestamp')]"
          },
          "groupAdminsName": {
            "value": "[parameters('groupAdminsName')]"
          },
          "groupUsersName": {
            "value": "[parameters('groupUsersName')]"
          },
          "groupAdminsGuid": {
            "value": "[parameters('groupAdminsGuid')]"
          },
          "groupUsersGuid": {
            "value": "[parameters('groupUsersGuid')]"
          },
          "ouPathStorage": {
            "value": "[parameters('ouPathStorage')]"
          },
          "ouPathVm": {
            "value": "[parameters('ouPathVm')]"
          },
          "privateDNSZoneId": {
            "value": "[parameters('privateDNSZoneId')]"
          },
          "privateDNSZoneKvId": {
            "value": "[parameters('privateDNSZoneKvId')]"
          },
          "privateEndPointPrefix": {
            "value": "[parameters('privateEndPointPrefix')]"
          },
          "scriptLocation": {
            "value": "[variables('scriptLocation')]"
          },
          "storageFileShareName": {
            "value": "[parameters('storageFileShareName')]"
          },
          "storageKind": {
            "value": "[variables('storageKind')]"
          },
          "storageResourceGroup": {
            "value": "[parameters('storageResourceGroup')]"
          },
          "storageSetupScript": {
            "value": "[variables('storageSetupScript')]"
          },
          "storageShareSize": {
            "value": "[parameters('storageShareSize')]"
          },
          "storsubnetId": {
            "value": "[parameters('storsubnetId')]"
          },
          "subscriptionId": {
            "value": "[parameters('subscriptionId')]"
          },
          "vmAdminPassword": {
            "value": "[parameters('vmAdminPassword')]"
          },
          "vmAdminUsername": {
            "value": "[parameters('vmAdminUsername')]"
          },
          "vmName": {
            "value": "[parameters('vmName')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.29.47.4906",
              "templateHash": "16767325039516417433"
            }
          },
          "parameters": {
            "domainJoinUserName": {
              "type": "string"
            },
            "domainJoinUserPassword": {
              "type": "securestring"
            },
            "domainFQDN": {
              "type": "string"
            },
            "domainGUID": {
              "type": "string"
            },
            "groupAdminsName": {
              "type": "string"
            },
            "groupAdminsGuid": {
              "type": "string"
            },
            "groupUsersName": {
              "type": "string"
            },
            "groupUsersGuid": {
              "type": "string"
            },
            "identityOption": {
              "type": "string"
            },
            "keyExpiration": {
              "type": "int"
            },
            "keyVaultName": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "managedIdentityName": {
              "type": "string"
            },
            "ouPathStorage": {
              "type": "string"
            },
            "ouPathVm": {
              "type": "string"
            },
            "privateDNSZoneId": {
              "type": "string"
            },
            "privateDNSZoneKvId": {
              "type": "string"
            },
            "privateEndPointPrefix": {
              "type": "string"
            },
            "scriptLocation": {
              "type": "string"
            },
            "storageAcctName": {
              "type": "string"
            },
            "storageFileShareName": {
              "type": "string"
            },
            "storageKind": {
              "type": "string"
            },
            "storageResourceGroup": {
              "type": "string"
            },
            "storageShareSize": {
              "type": "int"
            },
            "storageSetupScript": {
              "type": "string"
            },
            "storageSKU": {
              "type": "string"
            },
            "storsubnetId": {
              "type": "string"
            },
            "subscriptionId": {
              "type": "string"
            },
            "tags": {
              "type": "object"
            },
            "tenantId": {
              "type": "string"
            },
            "timestamp": {
              "type": "string"
            },
            "vmAdminPassword": {
              "type": "securestring"
            },
            "vmAdminUsername": {
              "type": "string"
            },
            "vmName": {
              "type": "string"
            },
            "vmsubnetId": {
              "type": "string"
            }
          },
          "variables": {
            "activeDirectoryProperties": "[if(equals(parameters('identityOption'), 'AADKERB'), createObject('domainName', parameters('domainFQDN'), 'netBiosDomainName', ' ', 'forestName', ' ', 'domainGuid', parameters('domainGUID'), 'domainSid', ' ', 'azureStorageSid', ' '), null())]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('managedIdentityName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            },
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('keyVaultName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "enablePurgeProtection": true,
                "enableSoftDelete": true,
                "enabledForDiskEncryption": true,
                "enableRbacAuthorization": true,
                "enabledForDeployment": true,
                "networkAcls": {
                  "defaultAction": "Deny",
                  "bypass": "AzureServices"
                },
                "publicNetworkAccess": "Disabled",
                "sku": {
                  "family": "A",
                  "name": "standard"
                },
                "softDeleteRetentionInDays": 7,
                "tenantId": "[parameters('tenantId')]"
              }
            },
            {
              "type": "Microsoft.KeyVault/vaults/keys",
              "apiVersion": "2023-07-01",
              "name": "[format('{0}/{1}', parameters('keyVaultName'), format('{0}-{1}', parameters('storageAcctName'), parameters('timestamp')))]",
              "tags": "[parameters('tags')]",
              "properties": {
                "attributes": {
                  "enabled": true,
                  "exp": "[parameters('keyExpiration')]"
                },
                "kty": "RSA",
                "keySize": 2048,
                "curveName": "P-256",
                "keyOps": [
                  "encrypt",
                  "decrypt",
                  "sign",
                  "verify",
                  "wrapKey",
                  "unwrapKey"
                ],
                "rotationPolicy": {
                  "attributes": {
                    "expiryTime": "P1Y"
                  },
                  "lifetimeActions": [
                    {
                      "action": {
                        "type": "rotate"
                      },
                      "trigger": {
                        "timeBeforeExpiry": "P90D"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', parameters('keyVaultName'))]",
              "name": "[guid(subscription().subscriptionId, 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]",
              "properties": {
                "description": "[format('Provides User Identity {0} access to Key Vault {1}', parameters('managedIdentityName'), parameters('keyVaultName'))]",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2023-01-31').principalId]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'e147488a-f6f5-4113-8e2d-b22465e65bf6')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]",
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2022-09-01",
              "name": "[parameters('storageAcctName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('storageSKU')]"
              },
              "kind": "[parameters('storageKind')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')))]": {}
                }
              },
              "properties": {
                "azureFilesIdentityBasedAuthentication": "[if(not(equals(variables('activeDirectoryProperties'), null())), createObject('directoryServiceOptions', parameters('identityOption'), 'activeDirectoryProperties', variables('activeDirectoryProperties')), null())]",
                "minimumTlsVersion": "TLS1_2",
                "supportsHttpsTrafficOnly": true,
                "allowBlobPublicAccess": false,
                "allowSharedKeyAccess": true,
                "defaultToOAuthAuthentication": false,
                "accessTier": "Hot",
                "publicNetworkAccess": "Disabled",
                "allowCrossTenantReplication": false,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Deny"
                },
                "dnsEndpointType": "Standard",
                "largeFileSharesState": "Enabled"
              },
              "dependsOn": [
                "[extensionResourceId(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), 'Microsoft.Authorization/roleAssignments', guid(subscription().subscriptionId, 'e147488a-f6f5-4113-8e2d-b22465e65bf6'))]",
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAcctName'))]",
              "name": "[guid(subscription().subscriptionId, '17d1049b-9a84-46fb-8f53-869881c3d3ab')]",
              "properties": {
                "description": "[format('Provides User Identity {0} access to StorageAccount for Domain Join Setup. ({1})', parameters('vmName'), parameters('storageAcctName'))]",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2023-01-31').principalId]",
                "principalType": "ServicePrincipal",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '17d1049b-9a84-46fb-8f53-869881c3d3ab')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAcctName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices/shares",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/default/{1}', parameters('storageAcctName'), parameters('storageFileShareName'))]",
              "properties": {
                "shareQuota": "[parameters('storageShareSize')]",
                "enabledProtocols": "SMB"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAcctName'))]"
              ]
            },
            {
              "type": "Microsoft.Storage/storageAccounts/fileServices",
              "apiVersion": "2022-09-01",
              "name": "[format('{0}/{1}', parameters('storageAcctName'), 'default')]",
              "properties": {
                "protocolSettings": {
                  "smb": {
                    "authenticationMethods": "NTLMv2;Kerberos",
                    "channelEncryption": "AES-128-CCM;AES-128-GCM;AES-256-GCM",
                    "kerberosTicketEncryption": "RC4-HMAC;AES-256",
                    "versions": "SMB3.0;SMB3.1.1"
                  }
                },
                "shareDeleteRetentionPolicy": {
                  "enabled": true,
                  "days": 7
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAcctName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAcctName'))]",
              "name": "[guid(subscription().subscriptionId, 'a7264617-510b-434b-a828-9731dc254ea7')]",
              "properties": {
                "description": "[format('Provides AVD Admins access to {0}', parameters('storageAcctName'))]",
                "principalId": "[parameters('groupAdminsGuid')]",
                "principalType": "Group",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'a7264617-510b-434b-a828-9731dc254ea7')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAcctName'))]"
              ]
            },
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAcctName'))]",
              "name": "[guid(subscription().subscriptionId, '0c867c2a-1d8c-454a-a3db-ab2ea1bdc8bb')]",
              "properties": {
                "description": "[format('Provides AVD Users access to {0} for FSlogix', parameters('storageAcctName'))]",
                "principalId": "[parameters('groupUsersGuid')]",
                "principalType": "Group",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '0c867c2a-1d8c-454a-a3db-ab2ea1bdc8bb')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAcctName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2020-07-01",
              "name": "[format('{0}-{1}', parameters('privateEndPointPrefix'), parameters('keyVaultName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('pep-{0}', parameters('keyVaultName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                      "groupIds": [
                        "vault"
                      ]
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('storsubnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAcctName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', format('{0}-{1}', parameters('privateEndPointPrefix'), parameters('keyVaultName')), 'vaultPrivateDnsZoneGroup')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "dnsConfig",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDNSZoneKvId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-{1}', parameters('privateEndPointPrefix'), parameters('keyVaultName')))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints",
              "apiVersion": "2020-07-01",
              "name": "[format('{0}-{1}', parameters('privateEndPointPrefix'), parameters('storageAcctName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "privateLinkServiceConnections": [
                  {
                    "name": "[format('pep-{0}', parameters('storageAcctName'))]",
                    "properties": {
                      "privateLinkServiceId": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAcctName'))]",
                      "groupIds": [
                        "file"
                      ]
                    }
                  }
                ],
                "subnet": {
                  "id": "[parameters('storsubnetId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAcctName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
              "apiVersion": "2020-06-01",
              "name": "[format('{0}/{1}', format('{0}-{1}', parameters('privateEndPointPrefix'), parameters('storageAcctName')), 'filePrivateDnsZoneGroup')]",
              "properties": {
                "privateDnsZoneConfigs": [
                  {
                    "name": "dnsConfig",
                    "properties": {
                      "privateDnsZoneId": "[parameters('privateDNSZoneId')]"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-{1}', parameters('privateEndPointPrefix'), parameters('storageAcctName')))]"
              ]
            },
            {
              "condition": "[equals(parameters('identityOption'), 'AD')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('linked_managementVm-{0}', parameters('storageAcctName'))]",
              "resourceGroup": "[parameters('storageResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "assignedIdentityId": {
                    "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]"
                  },
                  "domainJoinFQDN": {
                    "value": "[parameters('domainFQDN')]"
                  },
                  "domainJoinOUPath": {
                    "value": "[parameters('ouPathVm')]"
                  },
                  "domainJoinUserName": {
                    "value": "[parameters('domainJoinUserName')]"
                  },
                  "domainJoinUserPassword": {
                    "value": "[parameters('domainJoinUserPassword')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "subnetId": {
                    "value": "[parameters('vmsubnetId')]"
                  },
                  "vmName": {
                    "value": "[parameters('vmName')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "vmAdminPassword": {
                    "value": "[parameters('vmAdminPassword')]"
                  },
                  "vmAdminUsername": {
                    "value": "[parameters('vmAdminUsername')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.29.47.4906",
                      "templateHash": "2036838474113733927"
                    }
                  },
                  "parameters": {
                    "assignedIdentityId": {
                      "type": "string"
                    },
                    "domainJoinFQDN": {
                      "type": "string"
                    },
                    "domainJoinOUPath": {
                      "type": "string"
                    },
                    "domainJoinUserName": {
                      "type": "string"
                    },
                    "domainJoinUserPassword": {
                      "type": "securestring"
                    },
                    "location": {
                      "type": "string"
                    },
                    "subnetId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "timestamp": {
                      "type": "string",
                      "defaultValue": "[utcNow('u')]"
                    },
                    "vmName": {
                      "type": "string"
                    },
                    "vmAdminUsername": {
                      "type": "string"
                    },
                    "vmAdminPassword": {
                      "type": "securestring"
                    }
                  },
                  "variables": {
                    "securityProfileJson": {
                      "uefiSettings": {
                        "secureBootEnabled": true,
                        "vTpmEnabled": true
                      },
                      "securityType": "TrustedLaunch"
                    },
                    "imageToUse": {
                      "publisher": "MicrosoftWindowsDesktop",
                      "offer": "Windows-11",
                      "sku": "win11-23h2-ent",
                      "version": "latest"
                    },
                    "VmSize": "Standard_D2s_v4"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2022-11-01",
                      "name": "[format('nic-{0}', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[parameters('subnetId')]"
                              },
                              "primary": true,
                              "privateIPAddressVersion": "IPv4"
                            }
                          }
                        ],
                        "enableAcceleratedNetworking": true,
                        "enableIPForwarding": false
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2022-11-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "identity": {
                        "type": "UserAssigned",
                        "userAssignedIdentities": {
                          "[format('{0}', parameters('assignedIdentityId'))]": {}
                        }
                      },
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[variables('VmSize')]"
                        },
                        "storageProfile": {
                          "imageReference": "[variables('imageToUse')]",
                          "osDisk": {
                            "name": "[format('{0}_osdisk', parameters('vmName'))]",
                            "osType": "Windows",
                            "createOption": "FromImage",
                            "caching": "ReadWrite",
                            "deleteOption": "Delete"
                          },
                          "dataDisks": []
                        },
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('vmAdminUsername')]",
                          "adminPassword": "[parameters('vmAdminPassword')]",
                          "windowsConfiguration": {
                            "provisionVMAgent": true,
                            "enableAutomaticUpdates": false
                          },
                          "secrets": [],
                          "allowExtensionOperations": true
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}', parameters('vmName')))]",
                              "properties": {
                                "deleteOption": "Delete"
                              }
                            }
                          ]
                        },
                        "securityProfile": "[variables('securityProfileJson')]",
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": false
                          }
                        },
                        "licenseType": "Windows_Client"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', format('nic-{0}', parameters('vmName')))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2023-03-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'JsonADDomainExtension')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "forceUpdateTag": "[parameters('timestamp')]",
                        "publisher": "Microsoft.Compute",
                        "type": "JsonADDomainExtension",
                        "typeHandlerVersion": "1.3",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "Name": "[parameters('domainJoinFQDN')]",
                          "User": "[parameters('domainJoinUserName')]",
                          "Restart": "true",
                          "Options": "3",
                          "OUPath": "[parameters('domainJoinOUPath')]"
                        },
                        "protectedSettings": {
                          "Password": "[parameters('domainJoinUserPassword')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAcctName'))]"
              ]
            },
            {
              "condition": "[equals(parameters('identityOption'), 'AD')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('linked_managementVMscript-{0}', parameters('storageAcctName'))]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "domainJoinOUPath": {
                    "value": "[parameters('ouPathStorage')]"
                  },
                  "domainJoinUserName": {
                    "value": "[parameters('domainJoinUserName')]"
                  },
                  "domainJoinUserPassword": {
                    "value": "[parameters('domainJoinUserPassword')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "storageSetupScriptUri": {
                    "value": [
                      "[format('{0}/{1}', parameters('scriptLocation'), parameters('storageSetupScript'))]"
                    ]
                  },
                  "storageSetupScriptName": {
                    "value": "[parameters('storageSetupScript')]"
                  },
                  "storageSetupId": {
                    "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName')), '2023-01-31').clientId]"
                  },
                  "storageAccountName": {
                    "value": "[parameters('storageAcctName')]"
                  },
                  "storageFileShareName": {
                    "value": "[parameters('storageFileShareName')]"
                  },
                  "storageResourceGroup": {
                    "value": "[parameters('storageResourceGroup')]"
                  },
                  "subscriptionId": {
                    "value": "[parameters('subscriptionId')]"
                  },
                  "tags": {
                    "value": "[parameters('tags')]"
                  },
                  "tenantId": {
                    "value": "[parameters('tenantId')]"
                  },
                  "timestamp": {
                    "value": "[parameters('timestamp')]"
                  },
                  "vmName": {
                    "value": "[parameters('vmName')]"
                  },
                  "groupAdmins": {
                    "value": "[parameters('groupAdminsName')]"
                  },
                  "groupUsers": {
                    "value": "[parameters('groupUsersName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.29.47.4906",
                      "templateHash": "543013264962772197"
                    }
                  },
                  "parameters": {
                    "domainJoinOUPath": {
                      "type": "string"
                    },
                    "domainJoinUserName": {
                      "type": "string"
                    },
                    "domainJoinUserPassword": {
                      "type": "securestring"
                    },
                    "groupAdmins": {
                      "type": "string"
                    },
                    "groupUsers": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "storageAccountName": {
                      "type": "string"
                    },
                    "storageFileShareName": {
                      "type": "string"
                    },
                    "storageResourceGroup": {
                      "type": "string"
                    },
                    "storageSetupId": {
                      "type": "string"
                    },
                    "storageSetupScriptUri": {
                      "type": "array"
                    },
                    "storageSetupScriptName": {
                      "type": "string"
                    },
                    "subscriptionId": {
                      "type": "string"
                    },
                    "tags": {
                      "type": "object"
                    },
                    "tenantId": {
                      "type": "string"
                    },
                    "timestamp": {
                      "type": "string"
                    },
                    "vmName": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "cloud": "[environment().name]",
                    "scriptParams": "[format('-OuPath {0} -StorageAccountName {1} -StorageAccountResourceGroupName {2} -SubscriptionId {3} -TenantId {4} -AclUsers {5} -AclAdmins {6} -StorageFileShareName {7} -DomainJoinUserPrincipalName {8} -DomainJoinPassword {9} -StorageSetupId {10} -Cloud {11}', parameters('domainJoinOUPath'), parameters('storageAccountName'), parameters('storageResourceGroup'), parameters('subscriptionId'), parameters('tenantId'), parameters('groupUsers'), parameters('groupAdmins'), parameters('storageFileShareName'), parameters('domainJoinUserName'), parameters('domainJoinUserPassword'), parameters('storageSetupId'), variables('cloud'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2023-03-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'CustomScriptExtension')]",
                      "location": "[parameters('location')]",
                      "tags": "[parameters('tags')]",
                      "properties": {
                        "publisher": "Microsoft.Compute",
                        "type": "CustomScriptExtension",
                        "typeHandlerVersion": "1.10",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "timestamp": "[parameters('timestamp')]",
                          "fileUris": "[parameters('storageSetupScriptUri')]"
                        },
                        "protectedSettings": {
                          "commandToExecute": "[format('powershell -ExecutionPolicy Unrestricted -File {0} {1}', parameters('storageSetupScriptName'), variables('scriptParams'))]",
                          "managedIdentity": {
                            "clientId": "[parameters('storageSetupId')]"
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('storageResourceGroup')), 'Microsoft.Resources/deployments', format('linked_managementVm-{0}', parameters('storageAcctName')))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2022-09-01",
              "name": "[format('linked_storCMKsetup-{0}', parameters('storageAcctName'))]",
              "resourceGroup": "[parameters('storageResourceGroup')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultUri": "[if(endsWith(reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri, '/'), createObject('value', substring(reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri, 0, sub(length(reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri), 1))), createObject('value', reference(resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName')), '2023-07-01').vaultUri))]",
                  "keyVaultKeyName": {
                    "value": "[format('{0}-{1}', parameters('storageAcctName'), parameters('timestamp'))]"
                  },
                  "storageAcctName": {
                    "value": "[parameters('storageAcctName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "storageSKU": {
                    "value": "[parameters('storageSKU')]"
                  },
                  "storageKind": {
                    "value": "[parameters('storageKind')]"
                  },
                  "identityStorageSetupId": {
                    "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.29.47.4906",
                      "templateHash": "6769740530691487145"
                    }
                  },
                  "parameters": {
                    "storageAcctName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "storageSKU": {
                      "type": "string"
                    },
                    "storageKind": {
                      "type": "string"
                    },
                    "identityStorageSetupId": {
                      "type": "string"
                    },
                    "keyVaultUri": {
                      "type": "string"
                    },
                    "keyVaultKeyName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Storage/storageAccounts",
                      "apiVersion": "2022-09-01",
                      "name": "[parameters('storageAcctName')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "[parameters('storageSKU')]"
                      },
                      "kind": "[parameters('storageKind')]",
                      "properties": {
                        "minimumTlsVersion": "TLS1_2",
                        "supportsHttpsTrafficOnly": true,
                        "allowBlobPublicAccess": false,
                        "allowSharedKeyAccess": true,
                        "defaultToOAuthAuthentication": false,
                        "accessTier": "Hot",
                        "publicNetworkAccess": "Disabled",
                        "allowCrossTenantReplication": false,
                        "networkAcls": {
                          "bypass": "AzureServices",
                          "defaultAction": "Deny"
                        },
                        "dnsEndpointType": "Standard",
                        "largeFileSharesState": "Enabled",
                        "encryption": {
                          "identity": {
                            "userAssignedIdentity": "[parameters('identityStorageSetupId')]"
                          },
                          "keySource": "Microsoft.Keyvault",
                          "keyvaultproperties": {
                            "keyname": "[parameters('keyVaultKeyName')]",
                            "keyvaulturi": "[parameters('keyVaultUri')]"
                          },
                          "services": {
                            "file": {
                              "enabled": true
                            }
                          }
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/privateEndpoints/privateDnsZoneGroups', format('{0}-{1}', parameters('privateEndPointPrefix'), parameters('storageAcctName')), 'filePrivateDnsZoneGroup')]",
                "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('managedIdentityName'))]",
                "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                "[resourceId('Microsoft.KeyVault/vaults/keys', parameters('keyVaultName'), format('{0}-{1}', parameters('storageAcctName'), parameters('timestamp')))]",
                "[resourceId('Microsoft.Resources/deployments', format('linked_managementVMscript-{0}', parameters('storageAcctName')))]",
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAcctName'))]",
                "[resourceId('Microsoft.Network/privateEndpoints', format('{0}-{1}', parameters('privateEndPointPrefix'), parameters('storageAcctName')))]"
              ]
            }
          ]
        }
      }
    }
  ]
}